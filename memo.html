<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.min.js" type="text/javascript" charset="utf-8"></script>

    <title>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</title>
</head>
<body>
<div class="mainview">
    <div>
        <nav class="sidebar">
            <button onclick="toggleSidebar()">â˜°</button>
            <h2>clone</h2>
            <ul class="menu">
                <li class="menu-item open">
                    <div class="menu-link menu-toggle" data-tooltip="ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬">
                        <span class="menu-icon">ğŸ“</span>
                        <div>ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</div>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary btn-add" onclick="btn.add()">+</button>
                        <input class="input-tag" id="listName" value=""/>
                    </div>
                    <ul class="menu-sub">

                    </ul>
                </li>
            </ul>
        </nav>
    </div>

    <div>
        <div>
            <header class="topbar">
                <div class="topbar_menu" href="test.html">ë©”ë‰´ 1</div>
                <div class="topbar_menu" href="./memo.html">ë©”ë‰´ 2</div>
                <div class="topbar_menu">ë©”ë‰´ 3</div>
                <div class="topbar_menu">ë©”ë‰´ 4</div>
            </header>
        </div>

        <main class="content">
            <!-- ë³€ê²½ë¨: ê¸°ë³¸ ìŠ¤í”Œë¦¬í„° êµ¬ì¡°ë¥¼ content-sector ë‚´ë¶€ë¡œ ì´ë™ -->
        </main>

    </div>
</div>

<footer class="footer"></footer>

<script>
    let itemCounter = 1;
    const listNameInput = document.getElementById('listName');
    const menuList = document.querySelector('.menu-sub');
    const mainContent = document.querySelector('.content');

    // ì¶”ê°€ë¨: ë””ë°”ìš´ì‹±ì„ ìœ„í•œ íƒ€ì´ë¨¸ ë³€ìˆ˜
    let saveTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
        loadStateFromUrl();

        const existingSectors = document.querySelectorAll('.content-sector');
        const initialCount = existingSectors.length;
        itemCounter = initialCount + 1;

        // ë³€ê²½ë¨: ë””ë°”ìš´ì‹± ì¶”ê°€ (500ms)
        mainContent.addEventListener('input', (event) => {
            if (event.target.tagName === 'TEXTAREA') {
                const sectorElement = event.target.closest('.content-sector');

                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    saveStateToUrl();
                    // --- ì¶”ê°€: ë Œë”ë§ í˜¸ì¶œ ---
                    renderCode(sectorElement);
                }, 500);
            }
        });

        // ì¶”ê°€ë¨: ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
        initSplitters();
        // --- ì¶”ê°€: ì´ˆê¸° ë¡œë“œ ì‹œ ëª¨ë“  ì„¹í„° ë Œë”ë§ ---
        document.querySelectorAll('.content-sector').forEach(renderCode);
    });

    // ì¶”ê°€ë¨: ê°œë³„ ì„¹í„°ì˜ ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
    function initSectorSplitter(sectorElement) {
        const horizontalSplitter = sectorElement.querySelector('.splitter-horizontal');
        const verticalSplitter = sectorElement.querySelector('.splitter-vertical');
        const leftContainer = sectorElement.querySelector('.left-container');
        const memoArea = sectorElement.querySelector('.memo-area');
        const descriptionArea = sectorElement.querySelector('.description-area');
        const rightContainer = sectorElement.querySelector('.right-container');

        const resultIframe = sectorElement.querySelector('.result-iframe'); // ì¶”ê°€

        let isResizing = false;
        let currentSplitter = null;
        let startY = 0;
        let startX = 0;
        let startMemoRatio = 1;
        let startResultRatio = 1;
        let startLeftRatio = 1;
        let startRightRatio = 1;

        // rAFìš© latest mouse point
        let latestMouseX = null;
        let latestMouseY = null;

        // ì´ˆê¸° ë¹„ìœ¨ ì„¤ì •
        memoArea.style.flex = '1 0 0';
        descriptionArea.style.flex = '1 0 0';
        leftContainer.style.flex = '1 0 0';
        rightContainer.style.flex = '1 0 0';

        horizontalSplitter.addEventListener('mousedown', (e) => {
            isResizing = true;
            currentSplitter = 'horizontal';
            horizontalSplitter.classList.add('active');

            resultIframe.classList.add('dragging'); // ì¶”ê°€

            startY = e.clientY;
            const memoHeight = memoArea.getBoundingClientRect().height;
            const descriptionHeight = descriptionArea.getBoundingClientRect().height;
            const totalHeight = memoHeight + descriptionHeight;

            startMemoRatio = memoHeight / totalHeight;
            startResultRatio = descriptionHeight / totalHeight;

            e.preventDefault();
        });

        verticalSplitter.addEventListener('mousedown', (e) => {
            isResizing = true;
            currentSplitter = 'vertical';
            verticalSplitter.classList.add('active');

            resultIframe.classList.add('dragging'); // ì¶”ê°€

            startX = e.clientX;
            const leftWidth = leftContainer.getBoundingClientRect().width;
            const rightWidth = rightContainer.getBoundingClientRect().width;
            const totalWidth = leftWidth + rightWidth;

            startLeftRatio = leftWidth / totalWidth;
            startRightRatio = rightWidth / totalWidth;

            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            latestMouseX = e.clientX;
            latestMouseY = e.clientY;
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                horizontalSplitter.classList.remove('active');
                verticalSplitter.classList.remove('active');
                resultIframe.classList.remove('dragging'); // ì¶”ê°€
                currentSplitter = null;
            }
        });

        // rAF ë£¨í”„: ê³„ì† ì‹¤í–‰ë˜ë©°, ì¢Œí‘œ ë³€í™”ê°€ ìˆì„ ë•Œë§Œ UI ì—…ë°ì´íŠ¸
        function update() {
            if (isResizing && (latestMouseX !== null || latestMouseY !== null)) {
                if (currentSplitter === 'horizontal') {
                    const containerHeight = leftContainer.getBoundingClientRect().height - 4;
                    const deltaY = latestMouseY - startY;

                    const currentMemoHeight = containerHeight * startMemoRatio;
                    const newMemoHeight = currentMemoHeight + deltaY;

                    const newMemoRatio = newMemoHeight / containerHeight;
                    const newResultRatio = 1 - newMemoRatio;

                    if (newMemoRatio > 0.1 && newMemoRatio < 0.9) {
                        memoArea.style.flex = `${newMemoRatio} 0 0`;
                        descriptionArea.style.flex = `${newResultRatio} 0 0`;
                    }
                } else if (currentSplitter === 'vertical') {
                    const containerWidth = sectorElement.querySelector('.sector-grid-container')
                        .getBoundingClientRect().width - 4;

                    const deltaX = latestMouseX - startX;

                    const currentLeftWidth = containerWidth * startLeftRatio;
                    const newLeftWidth = currentLeftWidth + deltaX;

                    const newLeftRatio = newLeftWidth / containerWidth;
                    const newRightRatio = 1 - newLeftRatio;

                    if (newLeftRatio > 0.2 && newLeftRatio < 0.8) {
                        leftContainer.style.flex = `${newLeftRatio} 0 0`;
                        rightContainer.style.flex = `${newRightRatio} 0 0`;
                    }
                }
            }

            requestAnimationFrame(update);
        }

        requestAnimationFrame(update);
    }

    function initSplitters() {
        // ëª¨ë“  content-sectorì— ëŒ€í•´ ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
        document.querySelectorAll('.content-sector').forEach(sector => {
            initSectorSplitter(sector);
        });
    }


    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('collapsed');
    }

    // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ë° ë³€ê²½
    const btn = {
        add : function(){
            const itemName = listNameInput.value.trim();
            const itemID = "sector-" + itemCounter;
            const menuID = "menu-" + itemCounter;

            if(itemName==''){
                alert("ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ í•„ìš”");
                return;
            }

            // ì¶”ê°€ë¨: ë™ì¼í•œ ì´ë¦„ ì²´í¬
            const existingNames = Array.from(document.querySelectorAll('.menu-sub .menu-item div'))
                .map(div => div.textContent.trim());

            if(existingNames.includes(itemName)) {
                alert(`"${itemName}" ì´ë¦„ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤!`);
                return;
            }

            const li = document.createElement('li');
            li.className = 'menu-item';

            const a = document.createElement('a');
            a.href = '#';
            a.className = 'menu-link';
            a.setAttribute('data-tooltip',itemName)
            a.id = menuID;

            a.addEventListener('click', (event) => {
                event.preventDefault();
                this.changeSector(itemID, a);
            });

            a.innerHTML = `
                <span class="menu-icon">ğŸµ</span>
                <div>${itemName}</div>
            `;

            li.appendChild(a);
            menuList.appendChild(li);

            // ìˆ˜ì •ë¨: ìŠ¤í”Œë¦¬í„° êµ¬ì¡°ë¡œ content-sector ìƒì„±
            const sectorDiv = document.createElement('div');
            sectorDiv.className = 'content-sector';
            sectorDiv.id = itemID;

            const editorID = "editor-" + itemCounter;

            sectorDiv.innerHTML = `
                <div class="sector-grid-container">
                    <div class="left-container">
                        <div class="memo-area">
                            <div id="${editorID}" class="ace-editor-input"></div>
                        </div>
                        <div class="splitter splitter-horizontal"></div>
                        <div class="description-area">
                            <textarea class="description-input" placeholder="ì „ì²´ì ì¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        </div>
                    </div>
                    <div class="splitter splitter-vertical"></div>
                    <div class="right-container">
                        <div class="result-area">
                            <iframe class="result-iframe" sandbox="allow-scripts allow-modals"></iframe>
                        </div>
                    </div>
                </div>
            `;

            mainContent.appendChild(sectorDiv);

            // ì¶”ê°€ë¨: ìƒˆë¡œ ìƒì„±ëœ ì„¹í„°ì˜ ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
            initSectorSplitter(sectorDiv);

            // ì¶”ê°€ë¨: ìƒˆë¡œ ìƒì„±ëœ ì„¹í„°ì— Ace Editor ì´ˆê¸°í™”
            initAceEditor(sectorDiv, '');

            this.changeSector(itemID, a);

            listNameInput.value = '';

            itemCounter++;

            saveStateToUrl();
        },
        changeSector: function(sectorIdToShow, clickedLink) {
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });

            document.querySelectorAll('.content-sector').forEach(sector => {
                sector.classList.remove('active');
            });

            if (clickedLink) {
                clickedLink.classList.add('active');
            }

            const sectorToShow = document.getElementById(sectorIdToShow);
            if (sectorToShow) {
                sectorToShow.classList.add('active');
            }

            saveStateToUrl();
        }
    }

    // ë³€ê²½ë ë•Œë§ˆë‹¤ url ì €ì¥
    function saveStateToUrl() {
        const sectors = [];
        document.querySelectorAll('.content-sector').forEach((sectorDiv, index) => {
            const menuItem = document.querySelectorAll('.menu-sub .menu-item')[index];
            const menuName = menuItem.querySelector('div').textContent;

            // ìˆ˜ì •ë¨: ìŠ¤í”Œë¦¬í„° êµ¬ì¡°ì—ì„œ textarea ì°¾ê¸°
            // const memoContent = sectorDiv.querySelector('.memo-input')?.value || '';
            // ğŸŒŸ ë³€ê²½: textarea ëŒ€ì‹  Ace ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ğŸŒŸ
            const aceEditor = sectorDiv.aceEditorInstance;
            const memoContent = aceEditor ? aceEditor.getValue() : sectorDiv.querySelector('.ace-editor-input')?.textContent || '';

            const descContent = sectorDiv.querySelector('.description-input')?.value || '';
            const resultContent = sectorDiv.querySelector('.result-output')?.textContent || '';

            sectors.push({
                id: sectorDiv.id,
                name: menuName,
                memo: memoContent,
                description: descContent,
                result: resultContent
            });
        });

        const activeMenu = document.querySelector('.menu-link.active');
        const finalActiveMenuId = activeMenu ? activeMenu.id : null;

        const activeSector = document.querySelector('.content-sector.active');
        const finalSectorActiveId = activeSector ? activeSector.id : null;

        const state = {
            sectors: sectors,
            activeMenuId : finalActiveMenuId,
            activeSectorId: finalSectorActiveId
        };

        try {
            const jsonString = JSON.stringify(state);
            const utf8EncodedString = encodeURIComponent(jsonString);
            const base64String = btoa(utf8EncodedString);

            window.location.hash = base64String;

        } catch (e) {
            console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }

    // url ë¡œë“œ
    function loadStateFromUrl() {
        const hash = window.location.hash.substring(1);
        if (!hash) {
            return;
        }

        try {
            const jsonString = atob(hash);
            const state = JSON.parse(decodeURIComponent(jsonString));

            if (!state.sectors) return;

            const menuList = document.querySelector('.menu-sub');
            const mainContent = document.querySelector('.content');

            menuList.innerHTML = '';
            mainContent.innerHTML = '';

            state.sectors.forEach(sector => {
                const li = document.createElement('li');
                li.className = 'menu-item';
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'menu-link';
                a.setAttribute('data-tooltip', sector.name);
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    btn.changeSector(sector.id, a);
                });
                a.innerHTML = `<span class="menu-icon">ğŸµ</span><div>${sector.name}</div>`;
                li.appendChild(a);
                menuList.appendChild(li);

                // ìˆ˜ì •ë¨: ìŠ¤í”Œë¦¬í„° êµ¬ì¡°ë¡œ ë³µì›
                const sectorDiv = document.createElement('div');
                sectorDiv.className = 'content-sector';
                sectorDiv.id = sector.id;

                const editorID = sector.id.replace('sector-', 'editor-');
                sectorDiv.innerHTML = `
                    <div class="sector-grid-container">
                        <div class="left-container">
                            <div class="memo-area">
                                <div id="${editorID}" class="ace-editor-input">${sector.memo || ''}</div>
                            </div>
                            <div class="splitter splitter-horizontal"></div>
                            <div class="description-area">
                                <textarea class="description-input" placeholder="ì „ì²´ì ì¸ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">${sector.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="splitter splitter-vertical"></div>
                        <div class="right-container">
                            <div class="result-area">
                                <iframe class="result-iframe" sandbox="allow-scripts allow-modals"></iframe>
                            </div>
                        </div>
                    </div>
                `;

                mainContent.appendChild(sectorDiv);

                // ì¶”ê°€ë¨: ë³µì›ëœ ì„¹í„°ì˜ ìŠ¤í”Œë¦¬í„° ì´ˆê¸°í™”
                initSectorSplitter(sectorDiv);

                // ì¶”ê°€ë¨: ë³µì›ëœ ì„¹í„°ì— Ace Editor ì´ˆê¸°í™” (ì €ì¥ëœ ì½”ë“œ ì „ë‹¬)
                initAceEditor(sectorDiv, sector.memo || '');
            });

            if (state.activeSectorId) {
                const sectorToActivate = document.getElementById(state.activeSectorId);
                if (sectorToActivate) {
                    btn.changeSector(state.activeSectorId, state.activeMenuId);
                }
            }

            itemCounter = state.sectors.length + 1;

        } catch (e) {
            console.error("ìƒíƒœ ë³µì› ì‹¤íŒ¨:", e);
        }
    }

    // --- ì¶”ê°€: ì½”ë“œ ë Œë”ë§ í•¨ìˆ˜ ---
    function renderCode(sectorElement) {
        // 1. í•´ë‹¹ ì„¹í„°ì—ì„œ ì…ë ¥ ì˜ì—­ê³¼ iframeì„ ì°¾ìŠµë‹ˆë‹¤.
        // const memoInput = sectorElement.querySelector('.memo-input');
        // const resultIframe = sectorElement.querySelector('.result-iframe');
        // if (!memoInput || !resultIframe) return;
        // const code = memoInput.value;

        // ğŸŒŸ ë³€ê²½: memoInput ëŒ€ì‹  Ace ì¸ìŠ¤í„´ìŠ¤ ì°¸ì¡° ğŸŒŸ
        const aceEditor = sectorElement.aceEditorInstance;
        const resultIframe = sectorElement.querySelector('.result-iframe');
        if (!aceEditor || !resultIframe) return;

        // Ace ì¸ìŠ¤í„´ìŠ¤ì—ì„œ í˜„ì¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        const code = aceEditor.getValue();

        // 2. ì…ë ¥ëœ ì½”ë“œë¥¼ í¬í•¨í•˜ëŠ” ì™„ì „í•œ HTML ë¬¸ì„œ í…œí”Œë¦¿ì„ ë§Œë“­ë‹ˆë‹¤.
        // ì‚¬ìš©ìê°€ CSSë¥¼ ì…ë ¥í–ˆë‹¤ê³  ê°€ì •í•˜ê³  <style> íƒœê·¸ë¡œ ë¬¶ìŠµë‹ˆë‹¤.
        // HTML ì½”ë“œëŠ” <body> ì•ˆì— ì‚½ì…ë©ë‹ˆë‹¤.
        const content = `
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    /* ê¸°ë³¸ margin ì œê±° ë° iframe í¬ê¸° ì¡°ì •ì— ìœ ì—°í•˜ë„ë¡ ì„¤ì • */
                    body { margin: 0; padding: 0; font-family: sans-serif; }
                </style>
            </head>
            <body>
                ${code}
            </body>
            </html>
        `;

        // 3. iframeì— ì½˜í…ì¸ ë¥¼ ì”ë‹ˆë‹¤.// srcdoc ì‚¬ìš©
// srcdoc ì‚¬ìš©: ê°€ì¥ ê°„ê²°í•˜ê³  íš¨ìœ¨ì ì¸ ë°©ì‹
        resultIframe.srcdoc = content;
    }
    // -----------------------------

    // --- ì¶”ê°€: Ace Editor ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ì—°ê²° í•¨ìˆ˜ ---
    function initAceEditor(sectorElement, initialCode) {
        const editorID = sectorElement.querySelector('.ace-editor-input').id;

        // Ace ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const editor = ace.edit(editorID);

        // ê¸°ë³¸ ì„¤ì •
        editor.setTheme("ace/theme/monokai"); // ë‹¤í¬ í…Œë§ˆ ì„¤ì •
        editor.session.setMode("ace/mode/html"); // ê¸°ë³¸ ëª¨ë“œëŠ” HTMLë¡œ ì„¤ì •
        editor.setValue(initialCode || "", -1); // ì½”ë“œ ì„¤ì • ë° ì»¤ì„œë¥¼ ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™

        // ì—ë””í„°ì˜ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        editor.session.on('change', () => {
            // Ace ì—ë””í„° ë³€ê²½ ì‹œì—ë„ ê¸°ì¡´ ë””ë°”ìš´ì‹± ë¡œì§ì„ ë”°ë¥´ë„ë¡ êµ¬í˜„

            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                // Aceì—ì„œ ë³€ê²½ëœ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                const currentCode = editor.getValue();

                // Ace ì¸ìŠ¤í„´ìŠ¤ì— ì„ì‹œë¡œ ê°’ ì €ì¥ (ìƒíƒœ ì €ì¥ ì‹œ ì‚¬ìš©í•˜ê¸° ìœ„í•¨)
                sectorElement.aceEditorInstance = editor;

                saveStateToUrl();
                renderCode(sectorElement);
            }, 500);
        });

        // Ace ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì„¹í„° ìš”ì†Œì— ì €ì¥í•˜ì—¬ ë‚˜ì¤‘ì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•¨
        sectorElement.aceEditorInstance = editor;
    }
    // ----------------------------------------------------
</script>
</body>
</html>