<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <title>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</title>

</head>
<body>
<div class="mainview">
    <div>
        <nav class="sidebar">
            <button onclick="toggleSidebar()">â˜°</button>
            <h2>clone</h2>
            <ul class="menu">
                <li class="menu-item open">
                    <div class="menu-link menu-toggle">
                        <span class="menu-icon">ğŸ“</span>
                        <div>ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬</div>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-sm" style="margin-left: 20px;" onclick="btn.add()">+</button>
                        <input class="input-tag" id="listName" value=""/>
                    </div>
                    <ul class="menu-sub">

                    </ul>
                </li>
            </ul>
        </nav>
    </div>

    <div style="flex-grow: 1;">
        <div>
            <header class="topbar">
                <div class="topbar_menu" href="test.html">ë©”ë‰´ 1</div>
                <div class="topbar_menu" href="./memo.html">ë©”ë‰´ 2</div>
                <div class="topbar_menu">ë©”ë‰´ 3</div>
                <div class="topbar_menu">ë©”ë‰´ 4</div>
            </header>
        </div>

        <main class="content">

        </main>
    </div>
</div>


<footer class="footer">

</footer>

<script>
    let itemCounter = 1;
    const listNameInput = document.getElementById('listName');
    const menuList = document.querySelector('.menu-sub');
    const mainContent = document.querySelector('.content');

    document.addEventListener('DOMContentLoaded', () => {
        loadStateFromUrl();

        const existingSectors = document.querySelectorAll('.content-sector');

        const initialCount = existingSectors.length;

        itemCounter = initialCount + 1;


        mainContent.addEventListener('input', (event) => {
            // ì´ë²¤íŠ¸ê°€ textareaì—ì„œ ë°œìƒí–ˆëŠ”ì§€ í™•ì¸
            if (event.target.tagName === 'TEXTAREA') {
                // â–¼ ëª¨ë“  ë™ì‘ì˜ ëì— ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
                // (â˜…ê³ ê¸‰: ì„±ëŠ¥ì„ ìœ„í•´ Debounce í•¨ìˆ˜ë¥¼ ì“°ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤)
                saveStateToUrl();
            }
        });

    });



    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('collapsed');
    }

    const btn = {
        add : function(){

            const itemName = listNameInput.value.trim();
            const itemID = "sector-" + itemCounter;
            const menuID = "menu-" + itemCounter;

            if(itemName==''){
                alert("ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ í•„ìš”");
                return;
            }

            // <li> ìƒì„±
            const li = document.createElement('li');
            li.className = 'menu-item';

            // <a> ìƒì„±
            const a = document.createElement('a');
            a.href = '#'; // í˜ì´ì§€ ì´ë™ ë°©ì§€
            a.className = 'menu-link';
            a.id = menuID;

            // <a>ì— í´ë¦­ ì´ë²¤íŠ¸ ì§ì ‘ ì—°ê²° (onclick ì†ì„± ëŒ€ì‹ )
            a.addEventListener('click', (event) => {
                event.preventDefault(); // a íƒœê·¸ì˜ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ì´ë™) ë§‰ê¸°
                this.changeSector(itemID, a); // IDì™€ 'a'ìš”ì†Œ ìì‹ ì„ ì „ë‹¬
            });

            // <a> ë‚´ë¶€ì— HTML ì‚½ì…
            a.innerHTML = `
                    <span class="menu-icon">ğŸµ</span>
                    <div>${itemName}</div>
                `;

            // <ul>ì˜ ìì‹ìœ¼ë¡œ <li>ë¥¼, <li>ì˜ ìì‹ìœ¼ë¡œ <a>ë¥¼ ì¶”ê°€
            li.appendChild(a);
            menuList.appendChild(li);


            // <div> ìƒì„±
            const div = document.createElement('div');
            div.className = 'content-sector'; // ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°ë¥¼ ìœ„í•œ ê³µí†µ í´ë˜ìŠ¤
            div.id = itemID; // ë©”ë‰´ì™€ ì—°ê²°í•  ê³ ìœ  ID

            // <div> ë‚´ë¶€ì— HTML ì‚½ì…
            div.innerHTML = `
                    <textarea>${itemName}</textarea>
                `;

            // <main>ì˜ ìì‹ìœ¼ë¡œ <div> ì¶”ê°€
            mainContent.appendChild(div);

            // --- 3. ë°©ê¸ˆ ì¶”ê°€í•œ í•­ëª© í™œì„±í™” ---
            this.changeSector(itemID, a);

            // ì¹´ìš´í„° ì¦ê°€
            itemCounter++;

            saveStateToUrl();
        },
        changeSector: function(sectorIdToShow, clickedLink) {

            // --- 1. ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¸°ê¸° ë° ë©”ë‰´ ë¹„í™œì„±í™” ---
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });

            document.querySelectorAll('.content-sector').forEach(sector => {
                sector.classList.remove('active');
            });

            // --- 2. í´ë¦­í•œ í•­ëª©ë§Œ í™œì„±í™” ---

            if (clickedLink) {
                clickedLink.classList.add('active');
            }

            const sectorToShow = document.getElementById(sectorIdToShow);
            if (sectorToShow) {
                sectorToShow.classList.add('active');
            }

            saveStateToUrl();
        }
    }


    // urlì— ëª¨ë“  ê²ƒ ì €ì¥
    function saveStateToUrl() {
        // 1. ëª¨ë“  ë©”ë‰´ ì•„ì´í…œê³¼ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ìˆ˜ì§‘í•©ë‹ˆë‹¤.
        const sectors = [];
        document.querySelectorAll('.content-sector').forEach((sectorDiv, index) => {
            // ë©”ë‰´ ì•„ì´í…œ ì°¾ê¸° (ìˆœì„œê°€ ê°™ë‹¤ê³  ê°€ì •)
            const menuItem = document.querySelectorAll('.menu-sub .menu-item')[index];
            const menuName = menuItem.querySelector('div').textContent; // "ë°°ì—´ 1"
            const content = sectorDiv.querySelector('textarea').value;  // "textarea ì•ˆì˜ ë‚´ìš©"

            sectors.push({
                id: sectorDiv.id, // "sector-1"
                name: menuName,
                text: content
            });
        });

        // 2. í˜„ì¬ í™œì„±í™”ëœ ì•„ì´í…œ ID ì°¾ê¸°
        const activeMenu = document.querySelector('.menu-link.active');
        const finalActiveMenuId = activeMenu ? activeMenu.id : null;

        // â€» ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ, í™œì„± sectorì˜ idë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const activeSector = document.querySelector('.content-sector.active');
        const finalSectorActiveId = activeSector ? activeSector.id : null;


        // 3. í•˜ë‚˜ì˜ 'ìƒíƒœ ê°ì²´'ë¡œ ë§Œë“­ë‹ˆë‹¤.
        const state = {
            sectors: sectors,
            activeMenuId : finalActiveMenuId,
            activeSectorId: finalSectorActiveId
        };

        // 4. JSON -> Base64ë¡œ ì¸ì½”ë”©
        try {
            const jsonString = JSON.stringify(state);
            const utf8EncodedString = encodeURIComponent(jsonString);   // utf8 ë³€í™˜ ì¸ì½”ë”© ë¨¼ì €
            const base64String = btoa(utf8EncodedString); // btoa: Binary To ASCII

            // 5. URL í•´ì‹œì— ì ìš©
            window.location.hash = base64String;

        } catch (e) {
            console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", e);
        }
    }


    /**
     * URL í•´ì‹œë¥¼ ì½ì–´ í˜ì´ì§€ ìƒíƒœë¥¼ ë³µì›í•©ë‹ˆë‹¤.
     */
    function loadStateFromUrl() {
        const hash = window.location.hash.substring(1); // ë§¨ ì•ì˜ '#' ì œê±°
        if (!hash) {
            // í•´ì‹œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(ì˜ˆ: ì•„ì´í…œ 1ê°œ)ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
            // ì˜ˆì‹œ: addNewItem();
            return;
        }

        try {
            // 1. Base64 -> JSONìœ¼ë¡œ ë””ì½”ë”©
            const jsonString = atob(hash); // atob: ASCII To Binary
            const state = JSON.parse(jsonString);

            if (!state.sectors) return;

            // 2. ìƒíƒœ ê°ì²´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ UIë¥¼ ë‹¤ì‹œ ë§Œë“­ë‹ˆë‹¤.
            const menuList = document.querySelector('.menu-sub');
            const mainContent = document.querySelector('.content');

            // (ê¸°ì¡´ UI ì´ˆê¸°í™” - í•„ìš”ì‹œ)
            menuList.innerHTML = '';
            mainContent.innerHTML = '';

            state.sectors.forEach(sector => {
                // (addNewItem í•¨ìˆ˜ë¥¼ ì¬í™œìš©í•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤)
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ HTMLì„ ì§ì ‘ ìƒì„±í•©ë‹ˆë‹¤.

                // 1. ë©”ë‰´ ì•„ì´í…œ ìƒì„±
                const li = document.createElement('li');
                li.className = 'menu-item';
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'menu-link';
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    btn.changeSector(sector.id, a);
                });
                a.innerHTML = `<span class="menu-icon">ğŸµ</span><div>${sector.name}</div>`;
                li.appendChild(a);
                menuList.appendChild(li);

                // 2. ì½˜í…ì¸  ì˜ì—­ ìƒì„±
                const div = document.createElement('div');
                div.className = 'content-sector';
                div.id = sector.id;
                div.innerHTML = `<textarea>${sector.text}</textarea>`;
                mainContent.appendChild(div);
            });

            // 3. í™œì„± íƒ­ ë³µì›
            if (state.activeSectorId) {

                const sectorToActivate = document.getElementById(state.activeSectorId);
                if (sectorToActivate) {
                    btn.changeSector(state.activeSectorId, state.activeMenuId);
                }
            }

            // ì „ì—­ itemCounterë¥¼ ë¡œë“œëœ ê°œìˆ˜ + 1ë¡œ ì„¤ì •
            itemCounter = state.sectors.length + 1;


        } catch (e) {
            console.error("ìƒíƒœ ë³µì› ì‹¤íŒ¨:", e);
            // í•´ì‹œê°€ ê¹¨ì¡Œì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
        }
    }

</script>
</body>
</html>