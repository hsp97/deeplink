let itemCounter=1;const listNameInput=document.getElementById("listName"),menuList=document.querySelector(".menu-sub"),mainContent=document.querySelector(".content");let saveTimer=null;function initSectorSplitter(e){const t=e.querySelector(".splitter-horizontal"),n=e.querySelector(".splitter-vertical"),i=e.querySelector(".left-container"),o=e.querySelector(".memo-area"),r=e.querySelector(".description-area"),c=e.querySelector(".right-container"),a=e.querySelector(".result-iframe");let s=!1,l=null,d=0,u=0,m=1,v=1,p=1,h=1,f=null,S=null;o.style.flex="1 0 0",r.style.flex="1 0 0",i.style.flex="1 0 0",c.style.flex="1 0 0",t.addEventListener("mousedown",e=>{s=!0,l="horizontal",t.classList.add("active"),a.classList.add("dragging"),d=e.clientY;const n=o.getBoundingClientRect().height,i=r.getBoundingClientRect().height,c=n+i;m=n/c,v=i/c,e.preventDefault()}),n.addEventListener("mousedown",e=>{s=!0,l="vertical",n.classList.add("active"),a.classList.add("dragging"),u=e.clientX;const t=i.getBoundingClientRect().width,o=c.getBoundingClientRect().width,r=t+o;p=t/r,h=o/r,e.preventDefault()}),document.addEventListener("mousemove",e=>{s&&(f=e.clientX,S=e.clientY)}),document.addEventListener("mouseup",()=>{s&&(s=!1,t.classList.remove("active"),n.classList.remove("active"),a.classList.remove("dragging"),l=null)}),requestAnimationFrame(function t(){if(s&&(null!==f||null!==S))if("horizontal"===l){const e=i.getBoundingClientRect().height-4,t=(e*m+(S-d))/e,n=1-t;t>.1&&t<.9&&(o.style.flex=`${t} 0 0`,r.style.flex=`${n} 0 0`)}else if("vertical"===l){const t=e.querySelector(".sector-grid-container").getBoundingClientRect().width-4,n=(t*p+(f-u))/t,o=1-n;n>.2&&n<.8&&(i.style.flex=`${n} 0 0`,c.style.flex=`${o} 0 0`)}requestAnimationFrame(t)})}function initSplitters(){document.querySelectorAll(".content-sector").forEach(e=>{initSectorSplitter(e)})}function toggleSidebar(){document.querySelector(".sidebar").classList.toggle("collapsed")}document.addEventListener("DOMContentLoaded",()=>{loadStateFromUrl();const e=document.querySelectorAll(".content-sector").length;itemCounter=e+1,mainContent.addEventListener("input",e=>{if("TEXTAREA"===e.target.tagName){const t=e.target.closest(".content-sector");clearTimeout(saveTimer),saveTimer=setTimeout(()=>{saveStateToUrl(),renderCode(t)},500)}}),initSplitters(),document.querySelectorAll(".content-sector").forEach(renderCode)});const btn={add:function(){const e=listNameInput.value.trim(),t="sector-"+itemCounter,n="menu-"+itemCounter;if(""==e)return void alert("Î¶¨Ïä§Ìä∏ Ï∂îÍ∞Ä ÌïÑÏöî");if(Array.from(document.querySelectorAll(".menu-sub .menu-item div")).map(e=>e.textContent.trim()).includes(e))return void alert(`"${e}" Ïù¥Î¶ÑÏùÄ Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§!`);const i=document.createElement("li");i.className="menu-item";const o=document.createElement("a");o.href="#",o.className="menu-link",o.setAttribute("data-tooltip",e),o.id=n,o.addEventListener("click",e=>{e.preventDefault(),this.changeSector(t,o)}),o.innerHTML=`\n                <span class="menu-icon">üéµ</span>\n                <div>${e}</div>\n            `,i.appendChild(o),menuList.appendChild(i);const r=document.createElement("div");r.className="content-sector",r.id=t;const c="editor-"+itemCounter;r.innerHTML=`\n                <div class="sector-grid-container">\n                    <div class="left-container">\n                        <div class="memo-area">\n                            <div id="${c}" class="ace-editor-input"></div>\n                        </div>\n                        <div class="splitter splitter-horizontal"></div>\n                        <div class="description-area">\n                            <textarea class="description-input" placeholder="Ï†ÑÏ≤¥Ï†ÅÏù∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>\n                        </div>\n                    </div>\n                    <div class="splitter splitter-vertical"></div>\n                    <div class="right-container">\n                        <div class="result-area">\n                            <iframe class="result-iframe" sandbox="allow-scripts allow-modals"></iframe>\n                        </div>\n                    </div>\n                </div>\n            `,mainContent.appendChild(r),initSectorSplitter(r),initAceEditor(r,""),this.changeSector(t,o),listNameInput.value="",itemCounter++,saveStateToUrl()},changeSector:function(e,t){document.querySelectorAll(".menu-link").forEach(e=>{e.classList.remove("active")}),document.querySelectorAll(".content-sector").forEach(e=>{e.classList.remove("active")}),t&&t.classList.add("active");const n=document.getElementById(e);n&&n.classList.add("active"),saveStateToUrl()}};function saveStateToUrl(){const e=[];document.querySelectorAll(".content-sector").forEach((t,n)=>{const i=document.querySelectorAll(".menu-sub .menu-item")[n].querySelector("div").textContent,o=t.aceEditorInstance,r=o?o.getValue():t.querySelector(".ace-editor-input")?.textContent||"",c=t.querySelector(".description-input")?.value||"";e.push({id:t.id,name:i,memo:r,description:c})});const t=document.querySelector(".menu-link.active"),n=t?t.id:null,i=document.querySelector(".content-sector.active"),o=i?i.id:null,r={sectors:e,activeMenuId:n,activeSectorId:o};try{const e=JSON.stringify(r),t=encodeURIComponent(e),n=btoa(t);window.location.hash=n}catch(e){console.error("ÏÉÅÌÉú Ï†ÄÏû• Ïã§Ìå®:",e)}}function loadStateFromUrl(){const e=window.location.hash.substring(1);if(e)try{const t=atob(e),n=JSON.parse(decodeURIComponent(t));if(!n.sectors)return;const i=document.querySelector(".menu-sub"),o=document.querySelector(".content");if(i.innerHTML="",o.innerHTML="",n.sectors.forEach(e=>{const t=document.createElement("li");t.className="menu-item";const n=document.createElement("a");n.href="#",n.className="menu-link",n.setAttribute("data-tooltip",e.name),n.addEventListener("click",t=>{t.preventDefault(),btn.changeSector(e.id,n)}),n.innerHTML=`<span class="menu-icon">üéµ</span><div>${e.name}</div>`,t.appendChild(n),i.appendChild(t);const r=document.createElement("div");r.className="content-sector",r.id=e.id;const c=e.id.replace("sector-","editor-");r.innerHTML=`\n                    <div class="sector-grid-container">\n                        <div class="left-container">\n                            <div class="memo-area">\n                                <div id="${c}" class="ace-editor-input">${e.memo||""}</div>\n                            </div>\n                            <div class="splitter splitter-horizontal"></div>\n                            <div class="description-area">\n                                <textarea class="description-input" placeholder="Ï†ÑÏ≤¥Ï†ÅÏù∏ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">${e.description||""}</textarea>\n                            </div>\n                        </div>\n                        <div class="splitter splitter-vertical"></div>\n                        <div class="right-container">\n                            <div class="result-area">\n                                <iframe class="result-iframe" sandbox="allow-scripts allow-modals"></iframe>\n                            </div>\n                        </div>\n                    </div>\n                `,o.appendChild(r),initSectorSplitter(r),initAceEditor(r,e.memo||"")}),n.activeSectorId){document.getElementById(n.activeSectorId)&&btn.changeSector(n.activeSectorId,n.activeMenuId)}itemCounter=n.sectors.length+1}catch(e){console.error("ÏÉÅÌÉú Î≥µÏõê Ïã§Ìå®:",e)}}function renderCode(e){const t=e.aceEditorInstance,n=e.querySelector(".result-iframe");if(!t||!n)return;const i=`\n            <!DOCTYPE html>\n            <html>\n            <head>\n                <style>\n                    /* Í∏∞Î≥∏ margin Ï†úÍ±∞ Î∞è iframe ÌÅ¨Í∏∞ Ï°∞Ï†ïÏóê Ïú†Ïó∞ÌïòÎèÑÎ°ù ÏÑ§Ï†ï */\n                    body { margin: 0; padding: 0; font-family: sans-serif; }\n                </style>\n            </head>\n            <body>\n                ${t.getValue()}\n            </body>\n            </html>\n        `;n.srcdoc=i}function initAceEditor(e,t){const n=e.querySelector(".ace-editor-input").id,i=ace.edit(n);i.setTheme("ace/theme/monokai"),i.session.setMode("ace/mode/html"),i.setValue(t||"",-1),i.session.on("change",()=>{clearTimeout(saveTimer),saveTimer=setTimeout(()=>{e.aceEditorInstance=i,saveStateToUrl(),renderCode(e)},500)}),e.aceEditorInstance=i}